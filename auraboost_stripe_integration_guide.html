<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuraBoost - Stripe API Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Menlo', monospace;
            background-color: #0F172A;
            color: #F1F5F9;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 24px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
        }

        .title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 14px;
            color: #CBD5E1;
        }

        .section {
            background-color: #1E293B;
            border-left: 3px solid #667EEA;
            padding: 24px;
            margin-bottom: 24px;
            border-radius: 8px;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 16px;
            color: #F1F5F9;
        }

        .subsection-title {
            font-size: 14px;
            font-weight: bold;
            margin-top: 16px;
            margin-bottom: 8px;
            color: #E5E7EB;
        }

        .code-block {
            background-color: #0F172A;
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 6px;
            padding: 16px;
            overflow-x: auto;
            margin: 12px 0;
            font-size: 12px;
            line-height: 1.4;
            color: #A7F3D0;
        }

        .text {
            font-size: 12px;
            color: #CBD5E1;
            line-height: 1.7;
            margin-bottom: 12px;
        }

        .list {
            font-size: 12px;
            color: #CBD5E1;
            margin-left: 16px;
            margin-bottom: 12px;
        }

        .list-item {
            margin-bottom: 6px;
        }

        .list-item::before {
            content: "‚Üí ";
            color: #667EEA;
            font-weight: bold;
            margin-right: 8px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
        }

        .table th {
            background-color: rgba(102, 126, 234, 0.1);
            padding: 12px;
            text-align: left;
            font-size: 11px;
            font-weight: bold;
            color: #CBD5E1;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
        }

        .table td {
            padding: 12px;
            font-size: 11px;
            color: #CBD5E1;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }

        .highlight {
            background-color: rgba(102, 126, 234, 0.1);
            border-left: 2px solid #667EEA;
            padding: 12px;
            margin: 12px 0;
            font-size: 12px;
            color: #CBD5E1;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 24px;
            border-top: 1px solid rgba(102, 126, 234, 0.2);
            font-size: 11px;
            color: #6B7280;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">üîó Stripe API Integration Guide</div>
            <div class="subtitle">AuraBoost Creator Payout System Documentation</div>
        </div>

        <!-- OVERVIEW -->
        <div class="section">
            <div class="section-title">1. System Overview</div>
            
            <div class="text">
                AuraBoost uses Stripe to handle all creator payouts securely. The system works as follows:
            </div>

            <div class="list">
                <div class="list-item"><strong>Creator Setup:</strong> Creator connects their Stripe account via OAuth</div>
                <div class="list-item"><strong>Subscription:</strong> User subscribes to AuraBoost ($9.99/month)</div>
                <div class="list-item"><strong>Stripe Charge:</strong> Stripe processes payment, deducts Stripe fees</div>
                <div class="list-item"><strong>Commission Split:</strong> AuraBoost takes 70%, creator receives 30%</div>
                <div class="list-item"><strong>Accumulation:</strong> Earnings accumulate throughout the week</div>
                <div class="list-item"><strong>Payout:</strong> Every Monday, payouts initiated via Stripe Connect</div>
                <div class="list-item"><strong>Settlement:</strong> Creator receives funds 5-7 business days later</div>
            </div>

            <div class="highlight">
                üí° <strong>Key Numbers:</strong><br>
                ‚Ä¢ Subscription: $9.99/month per user<br>
                ‚Ä¢ Commission to Creator: 30% = $2.99/month<br>
                ‚Ä¢ AuraBoost Take: 70% = $6.99/month<br>
                ‚Ä¢ Payout Threshold: $25 minimum<br>
                ‚Ä¢ Payout Frequency: Weekly (Mondays)<br>
                ‚Ä¢ Settlement Time: 5-7 business days
            </div>
        </div>

        <!-- AUTHENTICATION -->
        <div class="section">
            <div class="section-title">2. Stripe Connect OAuth</div>

            <div class="subsection-title">Step 1: Redirect to Stripe Connect</div>
            <div class="text">
                When creator clicks "Connect Stripe", redirect to Stripe OAuth:
            </div>

            <div class="code-block">
const stripeConnectUrl = `https://connect.stripe.com/oauth/authorize?
  client_id=${process.env.STRIPE_CLIENT_ID}&
  response_type=code&
  scope=read_write&
  redirect_uri=${process.env.CALLBACK_URL}`;

window.location.href = stripeConnectUrl;
            </div>

            <div class="subsection-title">Step 2: Handle OAuth Callback</div>
            <div class="text">
                Stripe redirects back to your app with an authorization code:
            </div>

            <div class="code-block">
app.get('/auth/stripe/callback', async (req, res) => {
  const { code } = req.query;
  
  // Exchange code for access token
  const response = await fetch('https://connect.stripe.com/oauth/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      client_secret: process.env.STRIPE_SECRET_KEY,
      code,
      grant_type: 'authorization_code'
    })
  });

  const data = await response.json();
  const { stripe_user_id, access_token } = data;

  // Store creator's Stripe ID in database
  await db.creators.update(creatorId, {
    stripe_account_id: stripe_user_id,
    stripe_connected: true
  });

  res.redirect('/dashboard?connected=true');
});
            </div>
        </div>

        <!-- PAYMENT FLOW -->
        <div class="section">
            <div class="section-title">3. Payment Processing Flow</div>

            <div class="subsection-title">Step 1: Charge Customer</div>
            <div class="text">
                When user subscribes, charge them via Stripe:
            </div>

            <div class="code-block">
// Create subscription
const subscription = await stripe.subscriptions.create({
  customer: customerId,
  items: [{ price: 'price_auraboost_monthly' }],
  payment_behavior: 'default_incomplete',
  expand: ['latest_invoice.payment_intent'],
});

// Log referral commission
await db.referrals.create({
  creator_id: referrerCreatorId,
  user_id: newUserId,
  subscription_id: subscription.id,
  amount: 9.99,
  commission: 2.99, // 30% of $9.99
  status: 'pending',
  created_at: new Date()
});
            </div>

            <div class="subsection-title">Step 2: Track Earnings</div>
            <div class="text">
                Accumulate creator earnings weekly:
            </div>

            <div class="code-block">
// Calculate weekly earnings
const getCreatorWeeklyEarnings = async (creatorId) => {
  const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
  
  const referrals = await db.referrals.findMany({
    where: {
      creator_id: creatorId,
      status: 'completed',
      created_at: { $gte: oneWeekAgo }
    }
  });

  const totalEarnings = referrals.reduce((sum, r) => 
    sum + r.commission, 0
  );

  return totalEarnings;
};

// Apply badge multiplier if creator has Affiliate Badge
const applyBadgeMultiplier = (earnings, hasAffiliateBadge) => {
  return hasAffiliateBadge ? earnings * 3 : earnings;
};
            </div>
        </div>

        <!-- PAYOUT PROCESSING -->
        <div class="section">
            <div class="section-title">4. Payout Processing (Weekly)</div>

            <div class="subsection-title">Step 1: Calculate Payouts (Monday 12:00 AM UTC)</div>
            <div class="text">
                Run scheduled job every Monday:
            </div>

            <div class="code-block">
// Cron job: Every Monday at 00:00 UTC
schedule.scheduleJob('0 0 * * 1', async () => {
  console.log('üîÑ Processing weekly payouts...');

  // Get all creators with earnings >= $25
  const creators = await db.creators.findMany({
    where: {
      stripe_connected: true,
      pending_balance: { $gte: 25 }
    }
  });

  for (const creator of creators) {
    const earnings = creator.pending_balance;
    
    try {
      // Create payout
      const payout = await stripe.payouts.create(
        {
          amount: Math.round(earnings * 100), // Convert to cents
          currency: 'usd',
          description: `AuraBoost Earnings - Week of ${new Date().toISOString()}`
        },
        { stripeAccount: creator.stripe_account_id }
      );

      // Record payout
      await db.payouts.create({
        creator_id: creator.id,
        stripe_payout_id: payout.id,
        amount: earnings,
        status: 'processing',
        created_at: new Date()
      });

      // Reset pending balance
      await db.creators.update(creator.id, {
        pending_balance: 0
      });

      console.log(`‚úÖ Payout ${payout.id} created for ${creator.id}`);
    } catch (error) {
      console.error(`‚ùå Payout failed for ${creator.id}:`, error);
      // Retry logic, alert creator
    }
  }
});
            </div>

            <div class="subsection-title">Step 2: Track Payout Status</div>
            <div class="text">
                Monitor payout completion:
            </div>

            <div class="code-block">
// Webhook: stripe.payout.succeeded / stripe.payout.failed
app.post('/webhooks/stripe', async (req, res) => {
  const event = req.body;

  if (event.type === 'payout.paid') {
    const { id: payoutId } = event.data.object;
    
    await db.payouts.update(payoutId, {
      status: 'completed',
      completed_at: new Date()
    });

    console.log(`üí∞ Payout ${payoutId} completed!`);
  }

  if (event.type === 'payout.failed') {
    const { id: payoutId } = event.data.object;
    
    await db.payouts.update(payoutId, {
      status: 'failed',
      retry_count: { $inc: 1 }
    });

    console.log(`‚ùå Payout ${payoutId} failed. Retrying...`);
  }

  res.json({ received: true });
});
            </div>
        </div>

        <!-- API ENDPOINTS -->
        <div class="section">
            <div class="section-title">5. API Endpoints Required</div>

            <table class="table">
                <thead>
                    <tr>
                        <th>Endpoint</th>
                        <th>Method</th>
                        <th>Purpose</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>/api/stripe/connect</td>
                        <td>GET</td>
                        <td>Redirect to Stripe Connect OAuth</td>
                    </tr>
                    <tr>
                        <td>/api/stripe/callback</td>
                        <td>GET</td>
                        <td>Handle OAuth callback, store Stripe ID</td>
                    </tr>
                    <tr>
                        <td>/api/earnings</td>
                        <td>GET</td>
                        <td>Get creator's total/monthly/weekly earnings</td>
                    </tr>
                    <tr>
                        <td>/api/payouts</td>
                        <td>GET</td>
                        <td>Get payout history and status</td>
                    </tr>
                    <tr>
                        <td>/api/payout/request</td>
                        <td>POST</td>
                        <td>Request early payout (min $25)</td>
                    </tr>
                    <tr>
                        <td>/webhooks/stripe</td>
                        <td>POST</td>
                        <td>Listen for Stripe events (payout updates)</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- DATABASE SCHEMA -->
        <div class="section">
            <div class="section-title">6. Database Schema</div>

            <div class="subsection-title">Creators Table</div>
            <div class="code-block">
{
  id: string,
  email: string,
  username: string,
  stripe_account_id: string,      // Stripe Connect ID
  stripe_connected: boolean,
  pending_balance: number,         // $ accumulating for next payout
  total_earned: number,            // All time earnings
  has_affiliate_badge: boolean,    // 3X multiplier
  last_payout_date: Date,
  last_payout_amount: number,
  created_at: Date
}
            </div>

            <div class="subsection-title">Referrals Table</div>
            <div class="code-block">
{
  id: string,
  creator_id: string,         // Who referred
  user_id: string,            // Who subscribed
  subscription_id: string,    // Stripe subscription ID
  amount: 9.99,              // Subscription amount
  commission: number,         // Creator's 30%
  badge_multiplier: number,   // 1 or 3
  final_commission: number,   // commission √ó badge_multiplier
  status: 'pending' | 'completed' | 'cancelled',
  created_at: Date,
  completed_at: Date
}
            </div>

            <div class="subsection-title">Payouts Table</div>
            <div class="code-block">
{
  id: string,
  creator_id: string,
  stripe_payout_id: string,   // Stripe payout ID for tracking
  amount: number,
  status: 'pending' | 'processing' | 'completed' | 'failed',
  retry_count: number,
  method: 'bank' | 'paypal',  // Which account
  created_at: Date,
  processed_at: Date,
  completed_at: Date
}
            </div>
        </div>

        <!-- TESTING -->
        <div class="section">
            <div class="section-title">7. Testing in Stripe Sandbox</div>

            <div class="subsection-title">Test Card Numbers</div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Card Number</th>
                        <th>Use Case</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>4242 4242 4242 4242</td>
                        <td>Successful payment</td>
                    </tr>
                    <tr>
                        <td>4000 0000 0000 9995</td>
                        <td>Declined card</td>
                    </tr>
                    <tr>
                        <td>5555 5555 5555 4444</td>
                        <td>Mastercard test</td>
                    </tr>
                </tbody>
            </table>

            <div class="subsection-title">Test Stripe Connect</div>
            <div class="code-block">
// Use test mode account: pk_test_YOUR_KEY
// Connect test Stripe account
// Process test payment
// Verify payout in Stripe dashboard
// Check webhook delivery in Stripe logs
            </div>
        </div>

        <!-- SECURITY -->
        <div class="section">
            <div class="section-title">8. Security & Compliance</div>

            <div class="list">
                <div class="list-item"><strong>PCI-DSS:</strong> Never store full card numbers (Stripe handles)</div>
                <div class="list-item"><strong>Encryption:</strong> All API calls use HTTPS/TLS</div>
                <div class="list-item"><strong>Secrets:</strong> Store API keys in environment variables</div>
                <div class="list-item"><strong>Webhooks:</strong> Verify Stripe signature on all webhook events</div>
                <div class="list-item"><strong>Rate Limiting:</strong> Implement rate limits on payout requests</div>
                <div class="list-item"><strong>Audit Logs:</strong> Log all payout activities for compliance</div>
            </div>

            <div class="highlight">
                üîí <strong>Webhook Verification:</strong><br>
                Always verify Stripe webhook signatures using:<br>
                <code>stripe.webhooks.constructEvent(body, sig, endpointSecret)</code>
            </div>
        </div>

        <!-- DEPLOYMENT CHECKLIST -->
        <div class="section">
            <div class="section-title">9. Deployment Checklist</div>

            <div class="list">
                <div class="list-item">‚òê Set up Stripe Live account (not test mode)</div>
                <div class="list-item">‚òê Add production API keys to environment</div>
                <div class="list-item">‚òê Configure Stripe Connect OAuth redirect URI</div>
                <div class="list-item">‚òê Set up webhook endpoint with Stripe</div>
                <div class="list-item">‚òê Test end-to-end payment flow</div>
                <div class="list-item">‚òê Enable Stripe IP whitelisting</div>
                <div class="list-item">‚òê Configure SSL certificate on domain</div>
                <div class="list-item">‚òê Set up monitoring/alerting for failed payouts</div>
                <div class="list-item">‚òê Create support playbook for payout issues</div>
                <div class="list-item">‚òê Set up 1099 tax reporting integration</div>
            </div>
        </div>

        <div class="footer">
            <div>AuraBoost Stripe Integration Documentation</div>
            <div style="margin-top: 12px;">For questions: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="781c1d0e38190d0a190b1b191656